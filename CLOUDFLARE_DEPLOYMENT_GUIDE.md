# Next.js éƒ¨ç½²åˆ° Cloudflare Pages æŒ‡å—

æ­¤æ–‡æ¡£è¯¦ç»†è®°å½•äº†å°† Next.js é¡¹ç›®ä» Vercel æ¶æ„è¿ç§»åˆ° Cloudflare Pages çš„å®Œæ•´æ–¹æ¡ˆã€‚æœ¬é¡¹ç›®ä½¿ç”¨ `@opennextjs/cloudflare` ä½œä¸ºè½¬æ¢å±‚ï¼ˆAdapterï¼‰ï¼Œå¹¶é…ç½®äº† R2 å­˜å‚¨æ¡¶ä»¥æ”¯æŒæŒä¹…åŒ–ç¼“å­˜ã€‚

---

## ğŸ“… æ ¸å¿ƒæ¶æ„å˜åŒ–

| ç‰¹æ€§         | Vercel (åŸæ¶æ„)       | Cloudflare Pages (å½“å‰æ¶æ„)               |
| ------------ | --------------------- | ----------------------------------------- |
| **è¿è¡Œæ—¶**   | Node.js / Vercel Edge | **Cloudflare Workers** (Workerd)          |
| **æ„å»ºäº§ç‰©** | `.next` ç›®å½•          | **`.open-next/worker.js`** (ç»é€‚é…å™¨è½¬æ¢) |
| **å›¾ç‰‡ä¼˜åŒ–** | å†…ç½®æ”¯æŒ              | **å…³é—­** (æˆ–ä½¿ç”¨ Cloudflare Images)       |
| **ISR ç¼“å­˜** | è‡ªåŠ¨æŒä¹…åŒ–            | **éœ€è¦ R2 å­˜å‚¨æ¡¶** (å·²é…ç½®)               |
| **éƒ¨ç½²å‘½ä»¤** | `git push`            | `pnpm deploy` (æˆ– CI/CD)                  |

---

## âœ… å·²å®Œæˆçš„é…ç½®

é¡¹ç›®ä»£ç å·²å®Œæˆæ‰€æœ‰é€‚é…å·¥ä½œï¼ŒåŒ…æ‹¬ï¼š

1.  **é€‚é…å™¨é›†æˆ**ï¼š
    - ä¾èµ–å®‰è£…ï¼š`@opennextjs/cloudflare`
    - æ„å»ºè„šæœ¬ï¼š`package.json` ä¸­æ·»åŠ äº† `pages:build` å’Œ `deploy`

2.  **åŸºç¡€è®¾æ–½é…ç½® (`wrangler.toml`)**ï¼š
    - å…¥å£æ–‡ä»¶æŒ‡å‘è½¬æ¢åçš„ Worker
    - é™æ€èµ„æºç›®å½•æŒ‡å‘ `.open-next/assets`
    - **[æ–°å¢]** R2 å­˜å‚¨æ¡¶ç»‘å®šï¼š`pixel-starter-cache`

3.  **ç¼“å­˜é€‚é… (`open-next.config.ts`)**ï¼š
    - å¯ç”¨äº† `r2IncrementalCache`
    - ç¡®ä¿ `revalidate` å’Œ `fetch cache` æ•°æ®èƒ½å¤ŸæŒä¹…åŒ–

4.  **Next.js è°ƒæ•´ (`next.config.ts`)**ï¼š
    - `images: { unoptimized: true }`ï¼šé¿å…è¿è¡Œæ—¶æŠ¥é”™
    - `initOpenNextCloudflareForDev()`ï¼šæœ¬åœ°å¼€å‘æ¨¡æ‹Ÿ Cloudflare ç¯å¢ƒ

---

## ğŸš€ éƒ¨ç½²å‰å‡†å¤‡ (å…³é”®)

ç”±äºé¡¹ç›®ä¾èµ– R2 å­˜å‚¨æ¡¶æ¥ä¿å­˜ç¼“å­˜æ•°æ®ï¼Œé¦–æ¬¡éƒ¨ç½²å‰**å¿…é¡»**åœ¨ Cloudflare åå°å¯ç”¨ R2ã€‚

### âš ï¸ ç¬¬ä¸€æ­¥ï¼šå¯ç”¨ R2 æœåŠ¡
> è¿™é‡Œçš„æŠ¥é”™ `code: 10042` è¡¨ç¤º R2 æœåŠ¡å°šæœªåœ¨è´¦æˆ·ä¸­æ¿€æ´»ã€‚

1.  ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com)ã€‚
2.  åœ¨å·¦ä¾§èœå•æ‰¾åˆ° **R2**ã€‚
3.  å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨ï¼Œéœ€è¦è¾“å…¥ä¿¡ç”¨å¡ï¼ˆè¿™æ˜¯ Cloudflare çš„åæ»¥ç”¨è¦æ±‚ï¼ŒR2 æœ‰ 10GB å…è´¹é¢åº¦ï¼Œä¸€èˆ¬ä¸ä¼šæ‰£è´¹ï¼‰ã€‚
4.  ç‚¹å‡»å¯ç”¨è®¢é˜…ã€‚

### âš ï¸ ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå­˜å‚¨æ¡¶
å¯ç”¨æœåŠ¡åï¼Œåˆ›å»ºé¡¹ç›®æ‰€éœ€çš„å­˜å‚¨æ¡¶ï¼š

**æ–¹å¼ Aï¼šé€šè¿‡å‘½ä»¤è¡Œ (æ¨è)**
```bash
npx wrangler r2 bucket create pixel-starter-cache
```

**æ–¹å¼ Bï¼šé€šè¿‡ç½‘é¡µæ§åˆ¶å°**
1.  åœ¨ R2 é¡µé¢ç‚¹å‡» **"Create bucket"**ã€‚
2.  åç§°è¾“å…¥ï¼š`pixel-starter-cache`ã€‚
3.  ä½ç½®å»ºè®®é€‰æ‹©ï¼š`Automatic` æˆ–é è¿‘ç”¨æˆ·çš„åŒºåŸŸã€‚
4.  ç‚¹å‡»ç”±åˆ›å»ºã€‚

---

## ğŸ“¦ æ„å»ºä¸éƒ¨ç½²

### 1. æœ¬åœ°å¼€å‘
æ¨¡æ‹Ÿ Cloudflare ç¯å¢ƒè¿è¡Œï¼š
```bash
pnpm dev
# æˆ–
pnpm preview
```

### 2. éƒ¨ç½²ä¸Šçº¿
æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè‡ªåŠ¨å®Œæˆæ„å»ºã€è½¬æ¢å’Œå‘å¸ƒï¼š

```bash
pnpm deploy
```

è¿™ä¸ªå‘½ä»¤å®é™…ä¸Šæ‰§è¡Œäº†ï¼š
1.  `next build`ï¼šNext.js æ ‡å‡†æ„å»º
2.  `npx @opennextjs/cloudflare build`ï¼šè½¬æ¢ä¸º Worker ä»£ç 
3.  `npx @opennextjs/cloudflare deploy`ï¼šä¸Šä¼ åˆ° Cloudflare

---

## ğŸ” ç¼“å­˜æœºåˆ¶è¯¦è§£

æœ¬é¡¹ç›®ä½¿ç”¨äº† **R2** æ¥æ¨¡æ‹Ÿ Vercel çš„æŒä¹…åŒ–ç¼“å­˜ã€‚

### ä¸ºä»€ä¹ˆè¦é…ç½® R2ï¼Ÿ
Next.js çš„ ISR (å¢é‡é™æ€å†ç”Ÿ) å’Œ Fetch Cache éœ€è¦æŠŠç”Ÿæˆçš„ JSON/HTML å­˜ä¸‹æ¥ã€‚
- **æ—  R2**ï¼šæ¯æ¬¡ Worker é‡å¯æˆ–é‡æ–°éƒ¨ç½²ï¼Œç¼“å­˜æ¸…ç©ºã€‚ç”¨æˆ·ä¼šå‘ç°é¡µé¢åˆ·æ–°å˜æ…¢ï¼Œæˆ–è€…æ•°æ®ä¸ä¸€è‡´ã€‚
- **æœ‰ R2**ï¼šç¼“å­˜æŒä¹…åŒ–ã€‚Worker å®ä¾‹é‡å¯åä¾ç„¶èƒ½è¯»å–æ—§ç¼“å­˜ï¼Œç›´åˆ°è¿‡æœŸã€‚

### æ¶‰åŠçš„æµ‹è¯•é¡µé¢
ä½ å¯ä»¥åœ¨ `pnpm deploy` åè®¿é—®ä»¥ä¸‹é¡µé¢éªŒè¯ï¼š

-   `/cache-test/isr`ï¼šé…ç½®äº† `revalidate = 30`ã€‚å¦‚æœä¸é… R2ï¼Œé‡æ–°éƒ¨ç½²åæ—¶é—´ä¼šé‡ç½®ã€‚
-   `/cache-test/fetch-cache`ï¼šé…ç½®äº† API ç¼“å­˜ã€‚é…ç½® R2 åï¼Œå¤šä¸ªç”¨æˆ·è®¿é—®å°†å…±äº«åŒä¸€ä»½ API ç¼“å­˜æ•°æ®ã€‚

---

## ğŸ›  å¸¸è§é—®é¢˜æ’æŸ¥

### `A request to the Cloudflare API ... failed [code: 10042]`
- **åŸå› **ï¼šCloudflare è´¦æˆ·æœªå¯ç”¨ R2 æœåŠ¡ã€‚
- **è§£å†³**ï¼šå» Dashboard -> R2 ç»‘å®šæ”¯ä»˜æ–¹å¼å¹¶å¼€å¯æœåŠ¡ã€‚

### å›¾ç‰‡ä¸æ˜¾ç¤º
- **åŸå› **ï¼šNext.js é»˜è®¤å›¾ç‰‡ä¼˜åŒ–åœ¨ Cloudflare ä¸Šä¸å¯ç”¨ã€‚
- **è§£å†³**ï¼šç¡®è®¤ `next.config.ts` ä¸­å·²è®¾ç½® `extensions: { unoptimized: true }`ï¼Œæˆ–ä½¿ç”¨äº†å¤–éƒ¨å›¾åºŠã€‚

### éƒ¨ç½²åæ ·å¼ä¸¢å¤±
- **åŸå› **ï¼šé™æ€èµ„æºä¸Šä¼ å¤±è´¥ã€‚
- **è§£å†³**ï¼šæ£€æŸ¥ `wrangler.toml` ä¸­çš„ `assets` é…ç½®æ˜¯å¦æŒ‡å‘ `.open-next/assets`ã€‚

---

## å‚è€ƒæ–‡æ¡£
- [OpenNext Cloudflare æ–‡æ¡£](https://opennext.js.org/cloudflare)
- [Next.js Cache æ–‡æ¡£](https://nextjs.org/docs/app/building-your-application/caching)
